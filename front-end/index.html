<html>
<body></body>
<head>
    <script src = "https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src = "https://cdn.jsdelivr.net/npm/jquery-validation@1.17.0/dist/jquery.validate.min.js"></script>
    <script src = "https://d3js.org/d3.v4.min.js"></script>

    <script>
        var tileW, tileH;
        var viewportX, viewportY, curCanvasId, curCanvas;
        var viewportWidth, viewportHeight;

        if (typeof String.prototype.parseFunction != 'function') {
            String.prototype.parseFunction = function () {
                var funcReg = /function *[^()]*\(([^()]*)\)[ \n\t]*\{(.*)\}/gmi;
                var match = funcReg.exec(this.replace(/\n/g, ' '));
                if(match)
                    return new Function(match[1].split(','), match[2]);
                else
                    return null;
            };
        }

        function initialCanvas() {

            var svg = d3.select("body").append("svg")
                .attr("width", viewportWidth)
                .attr("height", viewportHeight);

            // get the current canvas and rendering function
            getCurCanvas();
            console.log(curCanvas);
            var renderFunc = curCanvas.rendering.parseFunction();

            // process tiles
            var margin = 0;
            var svgs= new Array(Math.floor(viewportWidth / tileW + (viewportWidth % tileW > 0 ? 1 : 0)));
            for (var i = 0; i < svgs.length; i ++)
                svgs[i] = new Array(Math.floor(viewportHeight / tileH + (viewportHeight % tileH > 0 ? 1 : 0)));
            for (var x = viewportX; x < viewportX + viewportWidth; x += tileW)
                for (var y = viewportY; y < viewportY + viewportHeight; y += tileH) {
                    // get i, j
                    var i = (x - viewportX) / tileW;
                    var j = (y - viewportY) / tileH;

                    svgs[i][j] = svg.append("svg")
                        .attr("x", x - viewportX + x / tileW * margin)
                        .attr("y", y - viewportY + y / tileH * margin)
                        .attr("width", tileW)
                        .attr("height", tileH)
                        .attr("viewBox", x + " " + y + " " + tileW + " " + tileH);
                    svgs[i][j].append("g").append("rect")
                        .attr("x", x)
                        .attr("y", y)
                        .attr("width", tileW)
                        .attr("height", tileH)
                        .style("fill", "beige");

                    // send request to backend to get render func and data
                    var postData = "id=" + curCanvasId + "&"
                        + "x=" + x + "&"
                        + "y=" + y;
                    $.post("/tile", postData, function (data, status) {
                        var response = JSON.parse(data);
                        var renderData = response.renderData;
                        var x = response.minx;
                        var y = response.miny;
                        var i = Math.floor((x - viewportX) / tileW);
                        var j = Math.floor((y - viewportY) / tileH);
                        renderFunc(svgs[i][j], renderData);
                    });
                }
        };

        function pageOnLoad() {

            // send the first request to backend server
            $.post("/first/", {}, function (data, status) {
                response = JSON.parse(data);
                console.log(response);
                viewportX = response.initialViewportX;
                viewportY = response.initialViewportY;
                viewportWidth = response.viewportWidth;
                viewportHeight = response.viewportHeight;
                curCanvasId = response.initialCanvasId;
                tileW = response.tileW;
                tileH = response.tileH;
                initialCanvas();
            });
        };

        $(document).ready(pageOnLoad);

        function getCurCanvas() {

            // TODO: client cache
            $.ajax({
                type : "POST",
                url : "canvas",
                data : curCanvasId,
                success : function (data, status) {
                    curCanvas = JSON.parse(data).canvas;
                },
                async : false
            });
        }

    </script>

</head>
</html>
