<html>
<body></body>
<head>
    <script src = "https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src = "https://cdn.jsdelivr.net/npm/jquery-validation@1.17.0/dist/jquery.validate.min.js"></script>
    <script src = "https://d3js.org/d3.v4.min.js"></script>

    <script>
        var tileW, tileH;
        var viewportX, viewportY, curCanvasId, curCanvas;
        var viewportWidth, viewportHeight;

        function initialCanvas() {

            var svg = d3.select("body").append("svg")
                .attr("width", viewportWidth)
                .attr("height", viewportHeight);

            // get the current canvas
            getCurCanvas();
            console.log(curCanvas);

            // process tiles
            var margin = 0;
            for (var x = viewportX; x < viewportX + viewportWidth; x += tileW)
                for (var y = viewportY; y < viewportY + viewportHeight; y += tileH) {
                    // new svg
                    var curSvg = svg.append("svg")
                        .attr("x", x - viewportX + x / tileW * margin)
                        .attr("y", y - viewportY + y / tileH * margin)
                        .attr("width", tileW)
                        .attr("height", tileH)
                        .attr("viewBox", x + " " + y + " " + tileW + " " + tileH);
                    curSvg.append("g").append("rect")
                        .attr("x", x)
                        .attr("y", y)
                        .attr("width", tileW)
                        .attr("height", tileH)
                        .style("fill", "beige");

                    // send request to backend to get render func and data
                    var postData = "id=" + curCanvasId + "&"
                        + "x=" + x + "&"
                        + "y=" + y;
                    $.ajax({
                        type : "POST",
                        url : "/tile",
                        data : postData,
                        success : function (data, status) {
                            var renderData = JSON.parse(data).renderData;
                            eval(curCanvas.rendering);
                            render(curSvg, renderData);
                        },
                        async : false
                    });
                }
        };

        function pageOnLoad() {

            // send the first request to backend server
            $.post("/first/", {}, function (data, status) {
                response = JSON.parse(data);
                console.log(response);
                viewportX = response.initialViewportX;
                viewportY = response.initialViewportY;
                viewportWidth = response.viewportWidth;
                viewportHeight = response.viewportHeight;
                curCanvasId = response.initialCanvasId;
                tileW = response.tileW;
                tileH = response.tileH;
                initialCanvas();
            });
        };

        $(document).ready(pageOnLoad);

        function getCurCanvas() {

            // TODO: client cache
            $.ajax({
                type : "POST",
                url : "canvas",
                data : curCanvasId,
                success : function (data, status) {
                    curCanvas = JSON.parse(data).canvas;
                },
                async : false
            });
        }

    </script>

</head>
</html>
